<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Happy (242) - Tokyo Westerns Qualifiers | Philip Z. Wang</title> <meta name="author" content="Philip Z. Wang"/> <meta name="description" content="Coppersmith's attack"/> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="/assets/img/prof_pic_20.jpg"/> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://pwang00.github.io//blog/2019/happy/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="https://pwang00.github.io//"><span class="font-weight-bold">Philip</span> Z. Wang</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/assets/pdf/pw_cv.pdf">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon"></i> <i class="fas fa-sun"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Happy (242) - Tokyo Westerns Qualifiers</h1> <p class="post-meta">September 6, 2019</p> <p class="post-tags"> <a href="/blog/2019"> <i class="fas fa-calendar fa-sm"></i> 2019 </a>   ·   <a href="/blog/tag/cryptography"> <i class="fas fa-hashtag fa-sm"></i> cryptography</a>   <a href="/blog/tag/math"> <i class="fas fa-hashtag fa-sm"></i> math</a>     ·   <a href="/blog/category/CTFs"> <i class="fas fa-tag fa-sm"></i> CTFs</a>   </p> </header> <article class="post-content"> <p>Happy was a 242 point crypto challenge on the 2019 Tokyo Westerns Qualifiers.</p> <h2 id="problem-description">Problem Description</h2> <p>No, we’Re not SAd. We are Happy!</p> <h2 id="solution">Solution</h2> <p>The problem description makes it pretty clear that this challenge is RSA. Indeed, we are given 3 files of importance: happy (.rb), pub.key, and flag.enc. We open happy.rb and find the definition of a custom defined Key class, which we figure out to be an implementation of multi-prime RSA (N = pq^k) (as shown below):</p> <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">return</span> <span class="no">Key</span><span class="p">.</span><span class="nf">new</span><span class="p">({</span>
    <span class="ss">n: </span><span class="nb">p</span> <span class="o">*</span> <span class="n">q</span> <span class="o">**</span> <span class="n">k</span><span class="p">,</span>
    <span class="ss">e: </span><span class="n">e</span><span class="p">,</span>
    <span class="ss">p: </span><span class="nb">p</span><span class="p">,</span>
    <span class="ss">q: </span><span class="n">q</span> <span class="o">**</span> <span class="n">k</span><span class="p">,</span>
    <span class="ss">d1: </span><span class="n">d1</span><span class="p">,</span>
    <span class="ss">d2: </span><span class="n">d2</span><span class="p">,</span>
    <span class="ss">cf: </span><span class="n">cf</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div></div> <p>Additionally, we note that the following lines are important:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>def self.import(str)
    Key.new(Marshal.load(str))
</code></pre></div></div> <p>So we can safely deduce here that the pub.key file is a serialized public key that is deserialized and parsed by the key class. Deserializing the pub.key file yields the following parameters:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>irb(main):001:0&gt; Marshal.load(File.binread("pub.key"))                                                  
=&gt; {:n=&gt;5452318773620154613572502669913080727339917760196646730652258556145398937256752632887555812737783373177353194432136071770417979324393263857781686277601413222025718171529583036919918011865659343346014570936822522629937049429335236497295742667600448744568785484756006127827416640477334307947919462834229613581880109765730148235236895292544500644206990455843770003104212381715712438639535055758354549980537386992998458659247267900481624843632733660905364361623292713318244751154245275273626636275353542053068704371642619745495065026372136566314951936609049754720223393857083115230045986813313700617859091898623345607326632849260775745046701800076472162843326078037832455202509171395600120638911, :e=&gt;65537, :cf=&gt;25895436290109491245101531425889639027975222438101136560069483392652360882638128551753089068088836092997653443539010850513513345731351755050869585867372758989503310550889044437562615852831901962404615732967948739458458871809980240507942550191679140865230350818204637158480970417486015745968144497190368319745738055768539323638032585508830680271618024843807412695197298088154193030964621282487334463994562290990124211491040392961841681386221639304429670174693151}
</code></pre></div></div> <p>Interesting–normally, an RSA public key would contain only \((N, e)\). The <code class="language-plaintext highlighter-rouge">cf</code> parameter certainly doesn’t seem to match any known implementation of RSA, so we assume for now that it’s an arbitrary parameter.</p> <p>Going back to the code, we find that <code class="language-plaintext highlighter-rouge">cf = p.pow(q ** (k - 1) * (q - 1) - 1, q ** k)</code>–in other words, \(cf \equiv p^{q^{(k - 1)}(q - 1) - 1} \pmod{q^k}\)</p> <p>We aren’t explicitly given \(k\), but we can deduce that \(k = 2\), since we know \(p\) and \(q\) are both \(b\)-bit long primes, \(N = pq^k\) has a bit length of 2295, and \(q^k\) has a bit length of 1530, so we can simply divide by 3 to get the bit length of each prime factor (765) and obtain 1530/765 = 2. With \(k = 2\), we can simplify our above equation to obtain \(cf \equiv p^{\phi(q^2) - 1} \pmod{q^2}\), and through Euler’s theorem, \(cf \equiv p^{-1} \pmod{q^2}\). In its current form, \(cf\) isn’t super useful since the only information we have on \(p\) is in the form of its inverse, but we can multiply both sides of the equation by \(p^2\) to obtain \((cf \cdot p - 1)p \equiv 0 \pmod{N}\). We multiply by \(p^2\) because we want to form a polynomial in \(p\) over \(\mathbb{Z}/(N)\), where we know \(N\):</p> \[cf \cdot p \equiv 1 \pmod{q^2}\] \[\implies cf \cdot p - 1 \equiv 0 \pmod{q^2}\] \[\implies cf \cdot p - 1 = kq^2\] <p>for some integer \(k\). So multiplying by an additional factor of \(p\) allows us to obtain</p> <p>\((cf \cdot p - 1)p = kpq^2 = kN\).</p> <p>This is equivalent to saying that</p> <p>\((cf \cdot p - 1)p \equiv 0 \pmod{N}\).</p> <p>From here, we can use Coppersmith’s algorithm to solve for \(p\).</p> <p>The code to do this is as follows:</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">n</span> <span class="o">=</span> <span class="mi">5452318773620154613572502669913080727339917760196646730652258556145398937256752632887555812737783373177353194432136071770417979324393263857781686277601413222025718171529583036919918011865659343346014570936822522629937049429335236497295742667600448744568785484756006127827416640477334307947919462834229613581880109765730148235236895292544500644206990455843770003104212381715712438639535055758354549980537386992998458659247267900481624843632733660905364361623292713318244751154245275273626636275353542053068704371642619745495065026372136566314951936609049754720223393857083115230045986813313700617859091898623345607326632849260775745046701800076472162843326078037832455202509171395600120638911</span>
<span class="n">cf</span> <span class="o">=</span> <span class="mi">25895436290109491245101531425889639027975222438101136560069483392652360882638128551753089068088836092997653443539010850513513345731351755050869585867372758989503310550889044437562615852831901962404615732967948739458458871809980240507942550191679140865230350818204637158480970417486015745968144497190368319745738055768539323638032585508830680271618024843807412695197298088154193030964621282487334463994562290990124211491040392961841681386221639304429670174693151</span>

<span class="n">P</span><span class="p">.</span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span> <span class="o">=</span> <span class="n">PolynomialRing</span><span class="p">(</span><span class="n">Zmod</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

<span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="n">cf</span> <span class="o">*</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span>

<span class="n">roots</span> <span class="o">=</span> <span class="n">f</span><span class="p">.</span><span class="n">monic</span><span class="p">().</span><span class="n">small_roots</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">roots</span><span class="p">)</span>

<span class="c1"># [0, 166878663790065040663149504970052368124427462024107500159158464138407657299730521908976684364578086644682045134207945137293534705688910696520830729908263578233018529387676221035298300775812585471932551347478303730822844748034186479]
</span></code></pre></div></div> <p>We see 2 results: 0 is a trivial root, so we can discard it, but we find out that the second value <code class="language-plaintext highlighter-rouge">166878663790065040663149504970052368124427462024107500159158464138407657299730521908976684364578086644682045134207945137293534705688910696520830729908263578233018529387676221035298300775812585471932551347478303730822844748034186479</code> divides N!</p> <p>Thus, we have found \(p\), and finding \(q\) is simply a matter of computing \(\sqrt{N / p}\). From here, computing \(\phi(N)\) and \(d\) is easy. However, the flag is padded with PKCS1_OAEP, so we have to PKCS1_OAEP unpad it to recover the original plaintext. We ran into incorrect decryption errors when trying to use pycrypto’s PKCS1_OAEP, and since we were sure all our recovered parameters were correct, we switched to the <em>cryptography</em> module for the last part of the challenge.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">key</span> <span class="o">=</span> <span class="n">RSA</span><span class="p">.</span><span class="n">construct</span><span class="p">((</span><span class="nb">long</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="nb">long</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="nb">long</span><span class="p">(</span><span class="n">d</span><span class="p">)))</span>

<span class="n">final_key</span> <span class="o">=</span> <span class="n">load_pem_private_key</span><span class="p">(</span>
		<span class="n">key</span><span class="p">.</span><span class="n">exportKey</span><span class="p">(),</span>
		<span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> 
		<span class="n">backend</span><span class="o">=</span><span class="n">default_backend</span><span class="p">()</span>
		<span class="p">)</span>

<span class="n">flag</span> <span class="o">=</span> <span class="n">final_key</span><span class="p">.</span><span class="n">decrypt</span><span class="p">(</span>
		<span class="n">c</span><span class="p">,</span>
		<span class="n">padding</span><span class="p">.</span><span class="n">OAEP</span><span class="p">(</span>
			<span class="n">mgf</span><span class="o">=</span><span class="n">padding</span><span class="p">.</span><span class="n">MGF1</span><span class="p">(</span><span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="p">.</span><span class="n">SHA1</span><span class="p">()),</span>
			<span class="n">algorithm</span><span class="o">=</span><span class="n">hashes</span><span class="p">.</span><span class="n">SHA1</span><span class="p">(),</span>
			<span class="n">label</span><span class="o">=</span><span class="bp">None</span>
			<span class="p">)</span>
		<span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">flag</span><span class="p">)</span>
</code></pre></div></div> <p>Running this produces the flag <code class="language-plaintext highlighter-rouge">TWCTF{I_m_not_sad__I_m_happy_always}</code>.</p> <p>The full code from start to finish can be found in solution.sage (install required libraries through <code class="language-plaintext highlighter-rouge">sage -pip install cryptography pycrypto</code> beforehand).</p> <h2 id="flag">Flag</h2> <p>TWCTF{I_m_not_sad__I_m_happy_always}</p> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Philip Z. Wang. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script> <script async src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>